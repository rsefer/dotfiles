#!/bin/sh
#
# access Local WP site shell and wp-cli

set -e

WORKING_CONFIG_FILE_NAME=".sdc-build-wp/config.json"

if [ ! -f $WORKING_CONFIG_FILE_NAME ]; then
	echo "No $WORKING_CONFIG_FILE_NAME found."
	WORKING_CONFIG_FILE_NAME="package.json"
	if [ ! -f $WORKING_CONFIG_FILE_NAME ]; then
		echo "No $WORKING_CONFIG_FILE_NAME found."
		exit 1
	else
		DOMAIN=$(cat $WORKING_CONFIG_FILE_NAME | jq -r '.sdc.browsersync.localProxyURL')
	fi
else
	DOMAIN=$(cat $WORKING_CONFIG_FILE_NAME | jq -r '.browsersync.localProxyURL')
fi

echo $DOMAIN

if [ -z "$DOMAIN" ] || [ $DOMAIN == "null" ]; then
	echo "No localProxyURL domain found in $PACKAGE_FILE_NAME."
	exit 1
fi

DOMAIN=${DOMAIN#"http://"}
DOMAIN=${DOMAIN#"https://"}

LOCAL_SITE_ID=$(cat /Users/"$USER"/Library/Application\ Support/Local/sites.json | jq -r ".[] | select(.domain == \"$DOMAIN\").id")

if [ -z "$LOCAL_SITE_ID" ] || [ $LOCAL_SITE_ID == "null" ]; then
	echo "No local site id found."
	exit 1
fi

exec /Users/"$USER"/Library/Application\ Support/Local/ssh-entry/$LOCAL_SITE_ID.sh
