#!/bin/sh
#
# access Local WP site shell and wp-cli

set -e

# Use first argument as DOMAIN if provided
if [ -n "$1" ]; then
	DOMAIN="$1"
else
	WORKING_CONFIG_FILE_NAME=".sdc-build-wp/config.json"

	if [ ! -f $WORKING_CONFIG_FILE_NAME ]; then
		echo "No $WORKING_CONFIG_FILE_NAME found."
		WORKING_CONFIG_FILE_NAME="package.json"
		if [ ! -f $WORKING_CONFIG_FILE_NAME ]; then
			echo "No $WORKING_CONFIG_FILE_NAME found."
			exit 1
		else
			DOMAIN=$(cat $WORKING_CONFIG_FILE_NAME | jq -r '.sdc.browsersync.localProxyURL')
		fi
	else
		DOMAIN=$(cat $WORKING_CONFIG_FILE_NAME | jq -r '.browsersync.localProxyURL')
	fi
fi

echo $DOMAIN

if [ -z "$DOMAIN" ] || [ $DOMAIN == "null" ]; then
	echo "No localProxyURL domain found in $PACKAGE_FILE_NAME."
	exit 1
fi

DOMAIN=${DOMAIN#"http://"}
DOMAIN=${DOMAIN#"https://"}

LOCAL_SITE_ID=$(cat /Users/"$USER"/Library/Application\ Support/Local/sites.json | jq -r ".[] | select(.domain == \"$DOMAIN\").id")

if [ -z "$LOCAL_SITE_ID" ] || [ $LOCAL_SITE_ID == "null" ]; then
	echo "No local site id found."
	exit 1
fi

if [ ! -e /Users/"$USER"/Library/Application\ Support/Local/ssh-entry/$LOCAL_SITE_ID.sh ]; then
	echo "No SSH entry script found for local site ID $LOCAL_SITE_ID."
	exit 1
fi

# Capture the current working directory so we return to it in the remote shell
WP_CONTENT_PATH="$(pwd)"

# Preserve the user's preferred shell (falls back to /bin/bash if unknown)
USER_SHELL=${SHELL:-/bin/bash}
REMOTE_SHELL=${REMOTE_SHELL:-$USER_SHELL}

# Prepare shell initialization so we cd into wp-content without breaking tools that
# expect $SHELL to be an actual shell binary (e.g., wp shell --shell).
case "$REMOTE_SHELL" in
	*/zsh)
		ZDOTDIR_SHIM=$(mktemp -d /tmp/local-wp-zdotdir-XXXX)
		cat > "$ZDOTDIR_SHIM/.zshrc" <<EOF
cd "$WP_CONTENT_PATH"
if [ -f "$HOME/.zshrc" ]; then
	source "$HOME/.zshrc"
fi
EOF
		export ZDOTDIR="$ZDOTDIR_SHIM"
		export SHELL="/bin/zsh"
		;;
	*/bash)
		# PROMPT_COMMAND runs before each prompt; use it once to cd, then unset to avoid repetition.
		export PROMPT_COMMAND="cd '$WP_CONTENT_PATH'; unset PROMPT_COMMAND"
		export SHELL="/bin/bash"
		;;
	*)
		# Fallback: a tiny shim shell that cd's then starts a login shell.
		SHELL_SHIM=$(mktemp /tmp/local-wp-shell-XXXX.sh)
		cat > "$SHELL_SHIM" <<EOF
#!/bin/sh
cd "$WP_CONTENT_PATH" && exec "$REMOTE_SHELL" -l
EOF
		chmod +x "$SHELL_SHIM"
		export SHELL="$SHELL_SHIM"
		;;
esac

exec /Users/"$USER"/Library/Application\ Support/Local/ssh-entry/$LOCAL_SITE_ID.sh
