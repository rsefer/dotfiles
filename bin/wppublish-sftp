#!/usr/bin/expect -f

set timeout -1

set ACTION [lindex $argv 0]
set HOST [lindex $argv 1]
set PORT [lindex $argv 2]
set USERNAME [lindex $argv 3]
set PASSWORD [lindex $argv 4]
set LOCALUPLOADNAME [lindex $argv 5]
set MOUNTNAME [lindex $argv 6]
set LOCALUPLOADDIR [lindex $argv 7]
set REMOTETHEMESPATH [lindex $argv 8]

set UNHOST "$USERNAME@$HOST"

if { $ACTION == "mount-and-rm" } {
	send_user "\nMounting SFTP volume:\n$USERNAME@$HOST:$REMOTETHEMESPATH\nto $LOCALUPLOADDIR/$MOUNTNAME\n\n"

	spawn -ignore HUP sshfs -o volname=$MOUNTNAME $UNHOST:$REMOTETHEMESPATH $LOCALUPLOADDIR/$MOUNTNAME
	expect {
		"$UNHOST's password: " { send -- "$PASSWORD\r" }
		"password: " { send -- "$PASSWORD\r" }
	}

	send_user "\nFinished mounting SFTP...\n\n"

} elseif { $ACTION == "put" } {
	send_user "\nUploading to SFTP...\n\n"

	spawn sftp -oPort=$PORT $UNHOST:$REMOTETHEMESPATH
	expect {
		"$UNHOST's password: " { send -- "$PASSWORD\r" }
		"password: " { send -- "$PASSWORD\r" }
	}
	expect "sftp>"

	send "cd $REMOTETHEMESPATH\r"
	expect "sftp>"

	send "ls\r"
	expect "sftp>"

	send "mkdir $LOCALUPLOADNAME\r"
	expect "sftp>"

	send "put -r $LOCALUPLOADDIR/$LOCALUPLOADNAME\r"
	expect "sftp>"

	send "exit\r"

	send_user "\rClosed SFTP..."
}

expect eof
